# Generated by iptables-save v1.4.14 on Mon Nov 17 18:45:27 2014
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:LOGGING - [0:0]
# Web server and ssh server
-A INPUT -i eth0 -p tcp -m multiport --dports 22,443,80 -m state --state NEW,ESTABLISHED -j ACCEPT
# Allow already established tcp & udp connections
-A INPUT -p tcp -m tcp -m state --state ESTABLISHED -j ACCEPT
-A INPUT -p udp -m udp -m state --state ESTABLISHED -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 0 -j ACCEPT
-A INPUT -i lo -j ACCEPT
-I INPUT -i {{local_int}} -p 112 -d 224.0.0.18 -j ACCEPT
{% if ansible_fqdn in groups['front'] %}
-A INPUT -p tcp -m tcp --dport 443 -m limit --limit 50/min --limit-burst 100 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -m limit --limit 50/min --limit-burst 100 -j ACCEPT
{% endif %}
{% if ansible_fqdn in groups['postgres'] %}
{% for ip in app_ips  %}
-A INPUT -i {{local_int}} -m state --state NEW  -p tcp -m tcp --dport {{postgresql_port}}  -j ACCEPT
-A INPUT -i {{local_int}} -m state --state NEW  -p tcp -m tcp --dport  9187 -j ACCEPT
{% endfor %}
{% if postgres_cluster_ports %}
-A INPUT -i {{local_int}} -m state --state NEW  -p tcp  --match multiport --dports {{postgres_cluster_ports | join(',')}} -j ACCEPT
{% endif %}
{% for ip in pg_ips  %}
-A INPUT -i {{local_int}} -s {{ip}} -m state --state NEW  -p tcp -m tcp --dport {{postgresql_port}}  -j ACCEPT
{% endfor %}
{% endif %}
{% if ansible_fqdn in groups['app'] %}
{% for ip in front_ips  %}
-A INPUT -i {{local_int}} -s {{ip}} -m state --state NEW  -p tcp -m tcp --dport {{gunicorn_bind_port}}  -j ACCEPT
{% endfor %}
{% endif %}
{% if ansible_fqdn in groups['monitoring'] %}
-A INPUT -i {{local_int}} -m state --state NEW  -p tcp -m tcp --dport {{grafana_port}}  -j ACCEPT
-A INPUT -i {{local_int}} -m state --state NEW  -p tcp -m tcp --dport 9200 -j ACCEPT
-A INPUT -i {{local_int}} -m state --state NEW  -p tcp -m tcp --dport 9300 -j ACCEPT
{% endif %}
{% for ip in monitor_ips  %}
-A INPUT -i {{local_int}} -s {{ip}} -m state --state NEW  -p tcp  --match multiport --dports {{prometheus_ports | join(',')}} -j ACCEPT
{% endfor %}
{% if ansible_fqdn in groups['etcd'] %}
-A INPUT -i {{local_int}} -m state --state NEW  -p tcp  --match multiport --dports 2379,2380 -j ACCEPT
{% endif %}


-A INPUT -i {{local_int}} -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -i {{nat_int}} -p tcp -m tcp --dport 22 -j ACCEPT

-A INPUT -j LOGGING
-A LOGGING -m limit --limit 2/min -j LOG --log-prefix "IPTables Packet Dropped: " --log-level 7
-A LOGGING -j DROP
COMMIT
# Completed on Mon Nov 17 18:45:27 2014
